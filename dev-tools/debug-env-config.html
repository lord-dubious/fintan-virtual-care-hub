<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Environment Configuration Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .config-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .env-var { margin: 5px 0; padding: 5px; background: #f5f5f5; border-radius: 3px; }
        .priority { font-weight: bold; color: #007acc; }
        .result { font-weight: bold; color: #28a745; }
        .error { color: #dc3545; }
    </style>
</head>
<body>
    <h1>üîß Frontend Environment Configuration Debug</h1>
    
    <div class="config-section">
        <h2>Environment Variables</h2>
        <div class="env-var">VITE_BACKEND_URL: <span id="vite-backend-url"></span></div>
        <div class="env-var">VITE_BACKEND_HOST: <span id="vite-backend-host"></span></div>
        <div class="env-var">VITE_BACKEND_PORT: <span id="vite-backend-port"></span></div>
    </div>

    <div class="config-section">
        <h2>Configuration Priority Test</h2>
        <div id="priority-test"></div>
    </div>

    <div class="config-section">
        <h2>Final API Configuration</h2>
        <div class="env-var">Detected Backend URL: <span id="final-backend-url" class="result"></span></div>
        <div class="env-var">Final API Base URL: <span id="final-api-url" class="result"></span></div>
    </div>

    <div class="config-section">
        <h2>Test API Call</h2>
        <button onclick="testAPICall()">Test Backend Connection</button>
        <div id="api-test-result"></div>
    </div>

    <script>
        // Simulate the frontend environment detection logic
        function getBackendURL() {
            // HIGHEST PRIORITY: Full URL override
            if (window.VITE_BACKEND_URL) {
                return window.VITE_BACKEND_URL;
            }
            
            // SECOND PRIORITY: Host + Port configuration
            if (window.VITE_BACKEND_HOST) {
                const host = window.VITE_BACKEND_HOST;
                const port = window.VITE_BACKEND_PORT || "3000";
                const protocol = 
                    host.includes("localhost") ||
                    host.includes("127.0.0.1") ||
                    /^\d+\.\d+\.\d+\.\d+$/.test(host)
                        ? "http"
                        : "https";
                
                if (host.startsWith("http")) {
                    return host;
                }
                
                if (
                    host.includes("localhost") ||
                    host.includes("127.0.0.1") ||
                    /^\d+\.\d+\.\d+\.\d+$/.test(host)
                ) {
                    return `${protocol}://${host}:${port}`;
                }
                
                return `${protocol}://${host}`;
            }
            
            // THIRD PRIORITY: Auto-detect from current window location
            if (typeof window !== "undefined") {
                const currentHost = window.location.hostname;
                const currentProtocol = window.location.protocol;
                
                if (
                    currentHost.includes("localhost") ||
                    currentHost.includes("127.0.0.1") ||
                    /^\d+\.\d+\.\d+\.\d+$/.test(currentHost)
                ) {
                    return `${currentProtocol}//${currentHost}:3000`;
                }
                
                return `${currentProtocol}//${currentHost}`;
            }
            
            // FALLBACK
            return "http://0.0.0.0:3000";
        }

        // Set mock environment variables for testing
        window.VITE_BACKEND_URL = ""; // Set this to test full URL override
        window.VITE_BACKEND_HOST = "localhost"; // Set this to test host override
        window.VITE_BACKEND_PORT = "3000";

        // Display environment variables
        document.getElementById('vite-backend-url').textContent = window.VITE_BACKEND_URL || 'Not set';
        document.getElementById('vite-backend-host').textContent = window.VITE_BACKEND_HOST || 'Not set';
        document.getElementById('vite-backend-port').textContent = window.VITE_BACKEND_PORT || 'Not set';

        // Test priority logic
        const priorityDiv = document.getElementById('priority-test');
        let priorityHTML = '';

        if (window.VITE_BACKEND_URL) {
            priorityHTML += '<div class="priority">‚úÖ PRIORITY 1: Using VITE_BACKEND_URL</div>';
        } else if (window.VITE_BACKEND_HOST) {
            priorityHTML += '<div class="priority">‚úÖ PRIORITY 2: Using VITE_BACKEND_HOST + VITE_BACKEND_PORT</div>';
        } else {
            priorityHTML += '<div class="priority">‚ö†Ô∏è PRIORITY 3: Auto-detecting from window.location</div>';
        }

        priorityDiv.innerHTML = priorityHTML;

        // Show final configuration
        const backendURL = getBackendURL();
        const apiURL = `${backendURL}/api`;

        document.getElementById('final-backend-url').textContent = backendURL;
        document.getElementById('final-api-url').textContent = apiURL;

        // Test API call
        async function testAPICall() {
            const resultDiv = document.getElementById('api-test-result');
            resultDiv.innerHTML = '<div>Testing connection...</div>';

            try {
                const response = await fetch(`${apiURL}/health`);
                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = `<div class="result">‚úÖ Success: ${JSON.stringify(data)}</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå HTTP ${response.status}: ${response.statusText}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Connection failed: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
