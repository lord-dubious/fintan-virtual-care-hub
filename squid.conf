# Squid Proxy Configuration for Ultra Data Compression, Ad Blocking & Minification
# Port: 3128 (default), allowing all networks

# Network Configuration
http_port 3128

# Allow all networks (be careful in production)
acl localnet src all
http_access allow localnet

# Basic ACLs
acl SSL_ports port 443
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http
acl CONNECT method CONNECT

# Ad Blocking Lists - Block common ad domains (must come before allow all)
acl ads_domains dstdomain "/etc/squid/ad_block_domains.txt"
http_access deny ads_domains

# Security rules
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localhost manager
http_access deny manager
http_access allow all

# Cache Configuration for Compression
cache_mem 512 MB
maximum_object_size_in_memory 2 MB
maximum_object_size 5 GB
minimum_object_size 0

# Larger cache for media files
maximum_object_size_in_memory 4 MB

# Cache directories
cache_dir ufs /var/spool/squid 10000 16 256

# Cache replacement policy
cache_replacement_policy lru

# Refresh patterns for better caching
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0

# Image caching patterns - cache images longer for better compression efficiency
refresh_pattern -i \.(jpg|jpeg|png|gif|webp|bmp|tiff|svg)(\?.*)?$ 10080 90% 43200 override-expire ignore-no-cache ignore-no-store ignore-private

# Video caching patterns - cache videos longer
refresh_pattern -i \.(mp4|mpeg|mov|avi|webm|ogg|3gp|flv)(\?.*)?$ 10080 95% 86400 override-expire ignore-no-cache ignore-no-store ignore-private

# CSS/JS caching for minification
refresh_pattern -i \.(css|js)(\?.*)?$ 1440 80% 10080 override-expire ignore-no-cache ignore-no-store ignore-private

refresh_pattern .               0       20%     4320

# Compression Settings
# Enable compression for text content
acl compressible_content rep_mime_type text/html
acl compressible_content rep_mime_type text/css
acl compressible_content rep_mime_type text/javascript
acl compressible_content rep_mime_type application/javascript
acl compressible_content rep_mime_type application/json
acl compressible_content rep_mime_type text/xml
acl compressible_content rep_mime_type application/xml

# Image compression support
acl compressible_images rep_mime_type image/jpeg
acl compressible_images rep_mime_type image/jpg
acl compressible_images rep_mime_type image/png
acl compressible_images rep_mime_type image/gif
acl compressible_images rep_mime_type image/webp
acl compressible_images rep_mime_type image/bmp
acl compressible_images rep_mime_type image/tiff
acl compressible_images rep_mime_type image/svg+xml

# Video compression support
acl compressible_video rep_mime_type video/mp4
acl compressible_video rep_mime_type video/mpeg
acl compressible_video rep_mime_type video/quicktime
acl compressible_video rep_mime_type video/x-msvideo
acl compressible_video rep_mime_type video/webm
acl compressible_video rep_mime_type video/ogg
acl compressible_video rep_mime_type video/3gpp
acl compressible_video rep_mime_type video/x-flv

# Memory and Performance Tuning
cache_mem 512 MB
memory_replacement_policy lru
cache_swap_low 90
cache_swap_high 95

# DNS Configuration
dns_nameservers 8.8.8.8 8.8.4.4 1.1.1.1

# Logging
access_log /var/log/squid/access.log squid
cache_log /var/log/squid/cache.log
cache_store_log none

# Headers for compression
request_header_max_size 64 KB
reply_header_max_size 64 KB

# Connection settings
client_lifetime 1 day
half_closed_clients off
pconn_timeout 60 seconds
request_timeout 5 minutes

# Memory pools
memory_pools on
memory_pools_limit 64 MB

# Coredump directory
coredump_dir /var/spool/squid

# Leave coredumps in the first cache dir
coredump_dir /var/spool/squid

# Hierarchy and peering (hierarchy_stoplist is obsolete in newer versions)

# Error pages
error_directory /usr/share/squid/errors/English

# Visible hostname
visible_hostname squid-proxy

# Administrative contact
cache_mgr admin@localhost

# Forwarded for header
forwarded_for on

# Via header
via on

# Store ID for better caching (disabled temporarily to prevent URL corruption)
# store_id_program /usr/local/bin/store_id_rewriter.pl
# store_id_children 20 startup=5 idle=1

# URL rewriter for minification and media compression
url_rewrite_program /usr/local/bin/url_minifier.pl
url_rewrite_children 15 startup=3 idle=2

# Client request size limits
request_body_max_size 100 MB

# Quick abort settings
quick_abort_min 16384
quick_abort_max 16384
quick_abort_pct 95

# Range offset limit
range_offset_limit 0

# Shutdown lifetime
shutdown_lifetime 30 seconds

# Strip query terms for better caching
strip_query_terms on

# Negative caching
negative_ttl 2 minutes
negative_dns_ttl 1 minutes

# Positive DNS caching
positive_dns_ttl 6 hours

# FTP settings
ftp_user squid@
ftp_passive on

# HTTP options
httpd_suppress_version_string on
